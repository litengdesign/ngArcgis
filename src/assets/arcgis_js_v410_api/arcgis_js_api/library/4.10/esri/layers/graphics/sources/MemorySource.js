// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.10/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper ../../../geometry ../../../Graphic ../../../core/Accessor ../../../core/Collection ../../../core/Error ../../../core/has ../../../core/Loadable ../../../core/Logger ../../../core/promiseUtils ../../../core/requireUtils ../../../core/workers ../../../core/accessorSupport/decorators ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/typescript ../../../tasks/support/FeatureSet module".split(" "),
function(w,q,x,g,p,u,d,y,r,z,A,B,v,C,D,n,E,F,G,H){Object.defineProperty(q,"__esModule",{value:!0});var I=0,t=B.getLogger("esri.layers.graphics.sources.MemorySource");d=function(d){function b(){var a=null!==d&&d.apply(this,arguments)||this;a._idToClientGraphic=null;a.type="memory";return a}x(b,d);b.prototype.load=function(){var a=this,c;c=v.resolve();this.addResolvingPromise(c.then(function(){return D.open(C.getAbsMid("./support/MemorySourceWorker",w,H),{strategy:z("esri-workers-for-memory-layers")?
"dedicated":"local"}).then(function(c){a._connection=c;var b=a.layer,l=b.fields,e=b.spatialReference,h=b.objectIdField,k=b.hasM,b=b.hasZ,f=a._prepareAddFeatures(a.items);a.on("before-changes",function(a){t.error("Source modifications will not propagate after layer has been loaded. Please use .applyEdits() instead");a.preventDefault()});return c.invoke("load",{features:f.features,fields:l&&l.map(function(a){return a.toJSON()}),geometryType:p.typeKebabDictionary.toJSON(a.workerGeometryType),hasM:k,
hasZ:b,objectIdField:h,spatialReference:e&&e.toJSON()}).then(function(c){for(var b=0,l=c.warnings;b<l.length;b++)t.warn(l[b]);c.featureErrors.length&&t.warn("Encountered "+c.featureErrors.length+" validation errors while loading features",c.featureErrors);b=c.layerDefinition;a._geometryTypeRequiresClientGraphicMapping(f.inferredGeometryType)&&(b.geometryType=p.typeKebabDictionary.toJSON(f.inferredGeometryType));a.layerDefinition=b;a._requiresClientGraphicMapping()&&(a._idToClientGraphic=new Map);
f.finish(c.assignedObjectIds)})})}));return this.when()};Object.defineProperty(b.prototype,"workerGeometryType",{get:function(){var a=this.layer&&this.layer.geometryType;return a?this._geometryTypeRequiresClientGraphicMapping(a)?"polygon":a:null},enumerable:!0,configurable:!0});b.prototype.applyEdits=function(a){var c=this;return this.load().then(function(){return c._applyEdits(a)})};b.prototype.openPorts=function(){var a=this;return this.load().then(function(){return a._connection.openPorts()})};
b.prototype.queryFeatures=function(a){var c=this;return this.load().then(function(){return c._connection.invoke("queryFeatures",a?a.toJSON():null)}).then(function(a){a=G.fromJSON(a);if(!c._idToClientGraphic)return a;for(var b=c.layer.objectIdField,l=0,e=a.features;l<e.length;l++){var h=e[l],k=c._idToClientGraphic.get(h.attributes[b]);k&&(h.geometry=k.geometry)}return a})};b.prototype.queryFeaturesJSON=function(a){var c=this;return this._requiresClientGraphicMapping()?v.reject(new r("query-features-json:unsupported",
"Cannot query in JSON format for client only geometry types (mesh and extent)")):this.load().then(function(){return c._connection.invoke("queryFeatures",a?a.toJSON():null)})};b.prototype.queryFeatureCount=function(a){var c=this;return this.load().then(function(){return c._connection.invoke("queryFeatureCount",a?a.toJSON():null)})};b.prototype.queryObjectIds=function(a){var c=this;return this.load().then(function(){return c._connection.invoke("queryObjectIds",a?a.toJSON():null)})};b.prototype.queryExtent=
function(a){var c=this;return this.load().then(function(){return c._connection.invoke("queryExtent",a?a.toJSON():null)}).then(function(a){return{count:a.count,extent:p.Extent.fromJSON(a.extent)}})};b.prototype._applyEdits=function(a){var c=this;if(!this._connection)throw new r("feature-layer-source:edit-failure","Memory source not loaded");var b=this.layer.objectIdField,m=null,d=[],e=[];a.addFeatures&&(m=this._prepareAddFeatures(a.addFeatures));if(a.deleteFeatures)for(var h=0,k=a.deleteFeatures;h<
k.length;h++){var f=k[h];"objectId"in f&&null!=f.objectId?d.push(f.objectId):"attributes"in f&&null!=f.attributes[b]&&d.push(f.attributes[b])}if(a.updateFeatures)for(b=0,a=a.updateFeatures;b<a.length;b++)f=a[b],e.push(this._serializeFeature(f));return this._connection.invoke("applyEdits",{adds:m?m.features:[],updates:e,deletes:d}).then(function(a){var b=a.featureEditResults;c.fullExtent=a.fullExtent;m&&m.finish(b.uidToObjectId);if(c._idToClientGraphic){a=0;for(var f=b.deleteResults;a<f.length;a++){var e=
f[a];e.success&&c._idToClientGraphic.delete(e.objectId)}}return c._createEditsResult(b)})};b.prototype._createEditsResult=function(a){return{addFeatureResults:a.addResults?a.addResults.map(this._createFeatureEditResult,this):[],updateFeatureResults:a.updateResults?a.updateResults.map(this._createFeatureEditResult,this):[],deleteFeatureResults:a.deleteResults?a.deleteResults.map(this._createFeatureEditResult,this):[]}};b.prototype._createFeatureEditResult=function(a){var b=!0===a.success?null:a.error||
{code:void 0,description:void 0};return{objectId:a.objectId,globalId:a.globalId,error:b?new r("feature-layer-source:edit-failure",b.description,{code:b.code}):null}};b.prototype._prepareAddFeatures=function(a){for(var b=new Map,d=Array(a.length),m=null,g=0;g<a.length;g++){var e=a[g],h=this._serializeFeature(e);!m&&e.geometry&&(m=e.geometry.type);d[g]=h;b.set(""+h.uid,e)}var k=this;return{features:d,inferredGeometryType:m,finish:function(a){var c=k.layerDefinition.objectIdField,e;for(e in a){var f=
a[e],d=b.get(e);d&&(d.attributes||(d.attributes={}),-1===f?delete d.attributes[c]:d.attributes[c]=f,k._addIdToClientGraphic(d))}}}};b.prototype._addIdToClientGraphic=function(a){if(this._idToClientGraphic){var b=this.layerDefinition.objectIdField,b=a.attributes&&a.attributes[b];null!=b&&this._idToClientGraphic.set(b,a)}};b.prototype._requiresClientGraphicMapping=function(){return this._geometryTypeRequiresClientGraphicMapping(this.layer.geometryType||this.layerDefinition.geometryType)};b.prototype._geometryRequiresClientGraphicMapping=
function(a){return this._geometryTypeRequiresClientGraphicMapping(a.type)};b.prototype._geometryTypeRequiresClientGraphicMapping=function(a){return"mesh"===a||"multipatch"===a||"extent"===a};b.prototype._serializeFeature=function(a){var b=a.attributes;a=this._geometryForSerialization(a);return{uid:""+I++,geometry:a?a.toJSON():null,attributes:b}};b.prototype._geometryForSerialization=function(a){return(a=a.geometry)?this._geometryRequiresClientGraphicMapping(a)?p.Polygon.fromExtent(a.extent):a:null};
g([F.shared({Type:u,ensureType:E.ensureType(u)})],b.prototype,"itemType",void 0);g([n.property()],b.prototype,"type",void 0);g([n.property({constructOnly:!0})],b.prototype,"layer",void 0);g([n.property({readOnly:!0,dependsOn:["layer.geometryType"]})],b.prototype,"workerGeometryType",null);g([n.property()],b.prototype,"layerDefinition",void 0);return b=g([n.subclass("esri.layers.graphics.sources.MemorySource")],b)}(n.declared(d,y,A));q.MemorySource=d;q.default=d});